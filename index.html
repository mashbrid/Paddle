<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paddle Controller</title>
<style>
body { font-family: Arial; text-align: center; margin: 5px; }
button { min-width: 150px; padding: 10px; font-size: 16px; cursor: pointer; border-radius: 5px; color: white; border: none; background: #007bff; margin-bottom: 4px; }
button:hover { background: #0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }
.columns { display: flex; justify-content: center; gap: 20px; margin-top: 5px; }
.column { display: flex; flex-direction: column; align-items: center; }
.slider-container { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
.slider-row { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }
.slider-box { display: flex; flex-direction: column; align-items: center; width: 100px; }
input[type="range"] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 40px; height: 180px; }
.slider-inner { display: flex; align-items: center; gap: 10px; }
.slider-current-value { min-width: 35px; font-weight: bold; text-align: right; }
.slider-scale { display: flex; flex-direction: column; justify-content: space-between; height: 180px; font-size: 12px; }
.slider-divider { width: 2px; background-color: #ccc; margin: 0 15px; align-self: stretch; }
</style>
</head>
<body>

<h1>Paddle Controller</h1>

<button id="connect-btn">Connect</button>

<div class="columns">
  <div class="column">
    <button id="fsr-btn" disabled>Grip Unk</button>
    <div id="fsr-value">FSR: -- Step: --</div>
  </div>
  <div class="column">
    <button id="xangle-btn" disabled>Angle Unk</button>
    <div id="xangle-value">X Angle: --</div>
  </div>
</div>

<div class="slider-container">

  <div class="slider-row">
    <div class="slider-box">
      <label for="grip-start-slider">HAPTIC START</label>
      <small>Vibration begins at this grip strength</small>
      <div class="slider-inner">
        <div class="slider-current-value" id="grip-start-current">4</div>
        <input type="range" id="grip-start-slider" min="2" max="10" step="1" value="4">
      </div>
    </div>

    <div class="slider-divider"></div>

    <div class="slider-box">
      <label for="haptic-start-pct">HAPTIC %</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="haptic-start-current">50</div>
        <input type="range" id="haptic-start-pct" min="0" max="100" step="1" value="50">
      </div>
    </div>

    <div class="slider-divider"></div>

    <div class="slider-box">
      <label for="angle-threshold">ANGLE THRESHOLD</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="angle-threshold-current">3</div>
        <input type="range" id="angle-threshold" min="0" max="10" step="1" value="3">
      </div>
    </div>

    <div class="slider-divider"></div>

    <div class="slider-box">
      <label for="angle-delay">ANGLE DELAY</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="angle-delay-current">0.8</div>
        <input type="range" id="angle-delay" min="0" max="5" step="0.1" value="0.8">
      </div>
    </div>
  </div>
</div>

<script>
let device, server, uartService, txCharacteristic, rxCharacteristic;
let isConnected = false;

// DOM elements
const connectBtn = document.getElementById('connect-btn');
const fsrBtn = document.getElementById('fsr-btn');
const fsrValue = document.getElementById('fsr-value');
const xangleBtn = document.getElementById('xangle-btn');
const xangleValue = document.getElementById('xangle-value');

let currentFSR = '--';
let currentStep = '--';

const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

// Connect / Disconnect
connectBtn.addEventListener('click', async () => {
  if (!isConnected) {
    try {
      device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
      server = await device.gatt.connect();
      uartService = await server.getPrimaryService(SERVICE_UUID);
      txCharacteristic = await uartService.getCharacteristic(TX_CHAR_UUID);
      rxCharacteristic = await uartService.getCharacteristic(RX_CHAR_UUID);

      await rxCharacteristic.startNotifications();
      rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

      isConnected = true;
      connectBtn.textContent = 'Disconnect';
      fsrBtn.disabled = false;
      xangleBtn.disabled = false;

      sendCommand('GET_FSR\n');
      sendCommand('GET_XANGLE\n');
    } catch (err) {
      console.error('Connection failed:', err);
      alert('Failed to connect: ' + err);
    }
  } else {
    if (device && device.gatt.connected) device.gatt.disconnect();
    isConnected = false;
    connectBtn.textContent = 'Connect';
    fsrBtn.disabled = true;
    xangleBtn.disabled = true;
    fsrBtn.textContent = 'Grip Unk';
    xangleBtn.textContent = 'Angle Unk';
    fsrValue.textContent = 'FSR: -- Step: --';
    xangleValue.textContent = 'X Angle: --';
  }
});

// Toggle buttons
fsrBtn.addEventListener('click', () => sendCommand('TOGGLE_FSR\n'));
xangleBtn.addEventListener('click', () => sendCommand('TOGGLE_XANGLE\n'));

// Send data to paddle
function sendCommand(cmd) {
  if (isConnected && txCharacteristic) {
    txCharacteristic.writeValue(new TextEncoder().encode(cmd)).catch(err => console.error('Write failed:', err));
  }
}

// Handle incoming BLE notifications
function handleNotifications(event) {
  const value = new TextDecoder().decode(event.target.value).trim();
  console.log('RX:', value);

  if (value.includes('FSR ENABLED')) fsrBtn.textContent = 'Turn Grip Off';
  else if (value.includes('FSR DISABLED')) fsrBtn.textContent = 'Turn Grip On';
  else if (value.startsWith('FSR:')) {
    currentFSR = value.split(':')[1].trim();
    fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`;
  }
  else if (value.startsWith('STEP:')) {
    currentStep = value.split(':')[1].trim();
    fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`;
  }
  else if (value.includes('XANGLE ENABLED')) xangleBtn.textContent = 'Turn Angle Off';
  else if (value.includes('XANGLE DISABLED')) xangleBtn.textContent = 'Turn Angle On';
  else if (value.startsWith('XANGLE:')) {
    const angle = value.split(':')[1].trim();
    xangleValue.textContent = `X Angle: ${angle}`;
  }
}

// Slider display updates
const sliders = [
  {slider: 'grip-start-slider', display: 'grip-start-current'},
  {slider: 'haptic-start-pct', display: 'haptic-start-current'},
  {slider: 'angle-threshold', display: 'angle-threshold-current'},
  {slider: 'angle-delay', display: 'angle-delay-current'}
];

sliders.forEach(({slider, display}) => {
  const sliderEl = document.getElementById(slider);
  const displayEl = document.getElementById(display);
  sliderEl.addEventListener('input', () => displayEl.textContent = sliderEl.value);
});
</script>

</body>
</html>
