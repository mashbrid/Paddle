<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paddle Controller</title>

    <style>
        /* =========================
           BASIC PAGE STYLING
           ========================= */

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 5px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        #connect-btn {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        /* =========================
           STATUS BUTTON COLUMNS
           ========================= */

        .columns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 5px;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        button {
            min-width: 150px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* =========================
           SLIDER LAYOUT
           ========================= */

        /* Container for all sliders */
        .slider-container {
            display: flex;
            flex-direction: column;   /* Stack rows vertically */
            gap: 20px;
            margin-top: 20px;
        }

        /* Each row holds two sliders */
        .slider-row {
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        /* Individual slider + label */
        .slider-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Vertical slider styling */
        input[type="range"] {
            writing-mode: bt-lr;              /* Vertical orientation */
            -webkit-appearance: slider-vertical;
            width: 40px;
            height: 180px;
        }

    </style>
</head>

<body>
    <div class="main-container">

        <h1>Paddle Controller</h1>

        <!-- Connect / Disconnect -->
        <button id="connect-btn">Connect</button>

        <!-- Status buttons -->
        <div class="columns">

            <!-- Grip / FSR column -->
            <div class="column">
                <button id="fsr-btn" disabled>Grip Unk</button>
                <div id="fsr-value">FSR: -- Step: --</div>
            </div>

            <!-- X Angle column -->
            <div class="column">
                <button id="xangle-btn" disabled>X Angle Unk</button>
                <div id="xangle-value">X Angle: --</div>
            </div>

        </div>
    </div>

    <!-- =========================
         HAPTIC & ANGLE SLIDERS
         ========================= -->

    <div class="slider-container">

        <!-- ROW 1 -->
        <div class="slider-row">

            <!-- Slider 1 -->
            <div class="slider-box">
                <label for="grip-start-slider">Haptic Start Level</label>
                <small>Vibration begins at this grip level</small>
                <input
                    type="range"
                    id="grip-start-slider"
                    min="2"
                    max="10"
                    step="1"
                    value="4">
            </div>

            <!-- Slider 2 -->
            <div class="slider-box">
                <label for="haptic-start-pct">Haptic Start %</label>
                <small>Strenght of initial Haptic</small>
                <input
                    type="range"
                    id="haptic-start-pct"
                    min="0"
                    max="100"
                    step="5"
                    value="40">
            </div>

        </div>

        <!-- ROW 2 -->
        <div class="slider-row">

            <!-- Slider 3 -->
            <div class="slider-box">
                <label for="angle-threshold">Paddle Up notification</label>
                <small>Up is 10, Flat is 0, Down is -10</small>
                <input
                    type="range"
                    id="angle-threshold"
                    min="-10"
                    max="10"
                    step="1"
                    value="-3">
            </div>

            <!-- Slider 4 -->
            <div class="slider-box">
                <label for="angle-delay">Paddle Up delay (0.5s)</label>
                <small>How long to wait</small>
                <input
                    type="range"
                    id="angle-delay"
                    min="0.5"
                    max="6"
                    step="0.5"
                    value="1.5">
            </div>
        </div>
    </div>

    <script>
        /* =========================
           BLE VARIABLES
           ========================= */

        let device;
        let server;
        let uartService;
        let txCharacteristic;
        let rxCharacteristic;
        let isConnected = false;

        /* Nordic UART Service UUIDs */
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

        /* UI elements */
        const connectBtn = document.getElementById('connect-btn');
        const fsrBtn = document.getElementById('fsr-btn');
        const fsrValue = document.getElementById('fsr-value');
        const xangleBtn = document.getElementById('xangle-btn');
        const xangleValue = document.getElementById('xangle-value');

        let currentFSR = '--';
        let currentStep = '--';

        /* =========================
           CONNECT / DISCONNECT
           ========================= */

        async function connect() {
            if (!isConnected) {
                try {
                    // Request device
                    device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SERVICE_UUID] }]
                    });

                    // Connect GATT
                    server = await device.gatt.connect();
                    uartService = await server.getPrimaryService(SERVICE_UUID);

                    // Get characteristics
                    txCharacteristic = await uartService.getCharacteristic(TX_CHAR_UUID);
                    rxCharacteristic = await uartService.getCharacteristic(RX_CHAR_UUID);

                    // Enable notifications
                    await rxCharacteristic.startNotifications();
                    rxCharacteristic.addEventListener(
                        'characteristicvaluechanged',
                        handleNotifications
                    );

                    // âœ… NOW we are truly connected
                    isConnected = true;
                    connectBtn.textContent = 'Disconnect';
                    fsrBtn.disabled = false;
                    xangleBtn.disabled = false;

                    // Fire-and-forget status queries (do NOT fail connection)
                    getFSRStatus();
                    getXangleStatus();

                    } catch (error) {
                        console.warn('BLE warning during connect:', error);

                        // Only alert if we truly did not connect
                        if (!device || !device.gatt || !device.gatt.connected) {
                            alert('Failed to connect. Please try again.');
                        }
                    }

            } else {
                disconnect();
            }
        }

        async function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }

            isConnected = false;
            connectBtn.textContent = 'Connect';
            fsrBtn.disabled = true;
            xangleBtn.disabled = true;
            fsrBtn.textContent = 'Grip Unk';
            xangleBtn.textContent = 'X Angle Unk';
            fsrValue.textContent = 'FSR: -- Step: --';
            xangleValue.textContent = 'X Angle: --';
        }

        /* =========================
           COMMANDS
           ========================= */

        async function toggleFSR() {
            if (!txCharacteristic) return;
            await txCharacteristic.writeValue(
                new TextEncoder().encode('TOGGLE_FSR\n')
            );
        }

        async function toggleXangle() {
            if (!txCharacteristic) return;
            await txCharacteristic.writeValue(
                new TextEncoder().encode('TOGGLE_XANGLE\n')
            );
        }

        async function getFSRStatus() {
            if (!txCharacteristic) return;
            await txCharacteristic.writeValue(
                new TextEncoder().encode('GET_FSR\n')
            );
        }

        async function getXangleStatus() {
            if (!txCharacteristic) return;
            await txCharacteristic.writeValue(
                new TextEncoder().encode('GET_XANGLE\n')
            );
        }

        /* =========================
           BLE NOTIFICATIONS
           ========================= */

        function handleNotifications(event) {
            const value = new TextDecoder()
                .decode(event.target.value)
                .trim();

            console.log('RX:', value);

            if (value.includes('FSR ENABLED')) {
                fsrBtn.textContent = 'Turn Grip Off';

            } else if (value.includes('FSR DISABLED')) {
                fsrBtn.textContent = 'Turn Grip On';

            } else if (value.startsWith('FSR:')) {
                currentFSR = value.split(':')[1].trim();
                fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`;

            } else if (value.startsWith('STEP:')) {
                currentStep = value.split(':')[1].trim();
                fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`;

            } else if (value.includes('XANGLE ENABLED')) {
                xangleBtn.textContent = 'Turn X Angle Off';

            } else if (value.includes('XANGLE DISABLED')) {
                xangleBtn.textContent = 'Turn X Angle On';

            } else if (value.startsWith('XANGLE:')) {
                const angle = value.split(':')[1].trim();
                xangleValue.textContent = `X Angle: ${angle}`;
            }
        }

        /* =========================
           EVENT LISTENERS
           ========================= */

        connectBtn.addEventListener('click', connect);
        fsrBtn.addEventListener('click', toggleFSR);
        xangleBtn.addEventListener('click', toggleXangle);

    </script>
</body>
</html>
