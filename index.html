<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paddle Controller</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  margin: 2px;                 /* Page edge padding (entire app) */
}

h1 {
  margin: 0;                   /* Removes default space above/below title */
  line-height: 1.1;            /* Tightens vertical height of title text */
}

button {
  width: 150px;
  height: 30px;
  font-size: 16px;
  padding: 5px;                /* Inner space inside button */
  cursor: pointer;
  border-radius: 5px;
  color: white;
  border: none;
  background: #007bff;
  margin-bottom: 4px;          /* Space below each button */
}

button:hover { background: #0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }

.small-button {
  width: 90px;
  height: 30px;
  font-size: 15px;
}

.columns {
  display: flex;
  justify-content: center;
  gap: 20px;                   /* Horizontal gap between Grip / Angle columns */
  margin-top: 2px;             /* Space below header section */
}

.column {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.header-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;                    /* Space between title and Connect button */
}

.slider-container {
  position: relative;           /* Allows absolute positioning of divider */  
  display: flex;
  justify-content: center;
  gap: 40px;                   /* Space between left/right slider columns */
  margin-top: 10px;            /* Space below Grip/Angle section */
}

.slider-inner {
  display: flex;
  align-items: center;
  gap: 4px;
  transform: translateX(-12px);   /* Nudges slider & value left */
}

.slider-container::before {
  content: "";
  position: absolute;
  top: 1px;                    /* Start below slider labels. Increase, line start lower */
  bottom: 80px;                /* Stop above Set Min / Max buttons. Increase, line stops higher */
  left: 50%;                     /* Center of container */
  width: 3px;                    /* Line thickness */
  background: #aaa;              /* Grey color */
  transform: translateX(-50%);   /* Perfect centering */
}

.slider-column {
  display: flex;
  flex-direction: column;
  gap: 20px;                   /* Vertical spacing between slider boxes */
  align-items: center;
}

.slider-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 120px;
}

input[type="range"] {
  writing-mode: bt-lr;
  -webkit-appearance: slider-vertical;
  width: 40px;
  height: 120px;               /* Vertical slider length */
}

.slider-inner {
  display: flex;
  align-items: center;
  gap: 4px;                    /* Space between value number and slider */
}

.slider-current-value {
  min-width: 35px;
  font-weight: bold;
  text-align: right;
}

.set-column {
  margin-top: 6px;             /* Space above Min/Max section */
  display: flex;
  flex-direction: column;
  align-items: center;
}

.set-row {
  display: flex;               /* Side-by-side Min / Max */
  gap: 10px;                   /* Space between Min and Max groups */
  justify-content: center;
}

.set-item {
  display: flex;               /* Stack button + value */
  flex-direction: column;
  align-items: center;
  gap: 2px;                    /* Space between button and value text */
}

.set-item div {
  font-size: 13px;             /* Smaller Min/Max value text */
  line-height: 1.1;            /* Tightens value text vertical space */
}

.narrow-button {
  width: 80px;                 /* Allows Min/Max to sit side-by-side */
}
</style>

</head>

<body>

<div class="header-container">
  <h1>Paddle Controller</h1>
  <button id="connect-btn">Connect</button>
</div>

<div class="columns">
  <div class="column">
    <button id="fsr-btn" disabled>Grip Unk</button>
    <div id="fsr-value">FSR: -- Step: --</div>
  </div>

  <div class="column">
    <button id="xangle-btn" disabled>Angle Unk</button>
    <div id="xangle-value">X Angle: --</div>
  </div>
</div>

<div class="slider-container">
  <!-- LEFT COLUMN -->
  <div class="slider-column">

    <div class="slider-box">
      <label>HAPTIC START</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="hstart-display">--</div>
        <input type="range" id="hstart-slider" min="2" max="10" step="1" value="4">
      </div>
    </div>

    <div class="slider-box">
      <label>HAPTIC %</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="haptic-pct-display">50</div>
        <input type="range" id="haptic-pct-slider" min="0" max="100" step="1" value="50">
      </div>
    </div>

    <div class="set-column">
      <div class="set-row">
        <div class="set-item">
          <button id="set-min-btn" class="small-button narrow-button">Set Min</button>
          <div id="step1-display">Min: --</div>
        </div>

        <div class="set-item">
          <button id="set-max-btn" class="small-button narrow-button">Set Max</button>
          <div id="step10-display">Max: --</div>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT COLUMN -->
  <div class="slider-column">
    <div class="slider-box">
      <label>ANGLE</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="angle-threshold-display">3</div>
        <input type="range" id="angle-threshold-slider" min="-10" max="10" step="1" value="3">
      </div>
    </div>

    <div class="slider-box">
      <label>ANGLE DELAY</label>
      <div class="slider-inner">
        <div class="slider-current-value" id="angle-delay-display">0.8</div>
        <input type="range" id="angle-delay-slider" min="0" max="5" step="0.1" value="0.8">
      </div>
    </div>
  </div>
</div>

<script>
let device, server, uartService, txCharacteristic, rxCharacteristic;
let isConnected = false;
let bleBusy = false;

let currentFSR = '--';
let currentStep = '--';

const connectBtn = document.getElementById('connect-btn');
const fsrBtn = document.getElementById('fsr-btn');
const xangleBtn = document.getElementById('xangle-btn');
const fsrValue = document.getElementById('fsr-value');
const xangleValue = document.getElementById('xangle-value');

const setMinBtn = document.getElementById('set-min-btn');
const setMaxBtn = document.getElementById('set-max-btn');
const step1Display = document.getElementById('step1-display');
const step10Display = document.getElementById('step10-display');

const hstartSlider = document.getElementById('hstart-slider');
const hstartDisplay = document.getElementById('hstart-display');

const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

async function sendCommand(cmd) {
  if (!isConnected || !txCharacteristic || bleBusy) return;
  try {
    bleBusy = true;
    await txCharacteristic.writeValue(
      new TextEncoder().encode(cmd)
    );
  } catch (err) {
    console.error('BLE write failed:', err);
  } finally {
    bleBusy = false;
  }
}

connectBtn.addEventListener('click', async () => {
  if (!isConnected) {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }]
    });

    server = await device.gatt.connect();
    uartService = await server.getPrimaryService(SERVICE_UUID);
    txCharacteristic = await uartService.getCharacteristic(TX_CHAR_UUID);
    rxCharacteristic = await uartService.getCharacteristic(RX_CHAR_UUID);

    await rxCharacteristic.startNotifications();
    rxCharacteristic.addEventListener('characteristicvaluechanged', handleRX);

    isConnected = true;
    connectBtn.textContent = 'Disconnect';
    fsrBtn.disabled = false;
    xangleBtn.disabled = false;

    /* AUTHORITATIVE STATE REQUESTS */
    await sendCommand('GET_FSR_STATE\n');     // Request Grip on/off
    await sendCommand('GET_XANGLE_STATE\n');  // Request XAngle on/off
    await sendCommand('GET_STEP1\n');         // Request Step 1 (min)
    await sendCommand('GET_STEP10\n');        // Request Step 10 (max)
    await sendCommand('GET_HSTART\n');        // Request haptic start value

  } else {
    device.gatt.disconnect();
    isConnected = false;
    connectBtn.textContent = 'Connect';
  }
});

fsrBtn.addEventListener('click', async () => {
  await sendCommand('TOGGLE_FSR\n');
});

xangleBtn.addEventListener('click', async () => {
  await sendCommand('TOGGLE_XANGLE\n');
});

setMinBtn.addEventListener('click', async () => {
  setMinBtn.disabled = true;
  await sendCommand('SET_MIN\n');
});

setMaxBtn.addEventListener('click', async () => {
  setMaxBtn.disabled = true;
  await sendCommand('SET_MAX\n');
});

hstartSlider.addEventListener('input', () => {
  hstartDisplay.textContent = hstartSlider.value;
});

hstartSlider.addEventListener('change', async () => {
  await sendCommand(`HSTART:${hstartSlider.value}\n`);
});

function handleRX(event) {
  const text = new TextDecoder().decode(event.target.value); // Decode BLE bytes to text

  text.split('\n').forEach(msg => {                           // Handle multiple messages per packet
    msg = msg.trim();                                         // Clean up whitespace
    if (!msg) return;                                         // Ignore empty lines

    console.log('RX:', msg);                                  // log every message received

     // message handling happens here

    if (msg === 'FSR ENABLED')
      fsrBtn.textContent = 'Grip On';                          // Update FSR button state

    else if (msg === 'FSR DISABLED')
      fsrBtn.textContent = 'Grip Off';                         // Update FSR button state

    else if (msg === 'XANGLE ENABLED')
      xangleBtn.textContent = 'Angle On';                      // Update X-angle button state

    else if (msg === 'XANGLE DISABLED')
      xangleBtn.textContent = 'Angle Off';                     // Update X-angle button state

    else if (msg.startsWith('FSR:')) {
      currentFSR = msg.split(':')[1];                          // Store current FSR value
      fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`; // Refresh display
    }

    else if (msg.startsWith('STEP:')) {
      currentStep = msg.split(':')[1];                         // Store current Step value
      fsrValue.textContent = `FSR: ${currentFSR} Step: ${currentStep}`; // Refresh display
    }

    else if (msg.startsWith('XANGLE:')) {
      xangleValue.textContent = `X Angle: ${msg.split(':')[1]}`; // Update X-angle display
    }

    else if (msg.startsWith('STEP1:')) {
      step1Display.textContent = `Min: ${msg.split(':')[1]}`;  // Show Step 1 calibration
      setMinBtn.disabled = false;                               // Enable SET MIN button
    }

    else if (msg.startsWith('STEP10:')) {
      step10Display.textContent = `Max: ${msg.split(':')[1]}`; // Show Step 10 calibration
      setMaxBtn.disabled = false;                               // Enable SET MAX button
    }

    else if (msg.startsWith('HSTART:')) {
      const val = msg.split(':')[1];                            // Extract haptic start step
      hstartSlider.value = val;                                 // Update slider
      hstartDisplay.textContent = val;                          // Update numeric display
    }
  });
}
</script>

</body>
</html>
